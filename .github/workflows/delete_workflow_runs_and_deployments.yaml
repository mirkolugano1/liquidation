name: Delete Old Workflow Runs And Deployments

on:
    schedule:
        - cron: "0 0 * * *" # Runs daily at midnight UTC, change as needed

jobs:
    delete_runs:
        runs-on: ubuntu-latest
        permissions:
            actions: write # Needed for deleting runs
        steps:
            - name: Install GitHub CLI
              run: sudo apt-get install gh -y

            - name: Delete workflow runs
              run: |
                  gh run list --limit 100 --json databaseId,createdAt \
                  --jq '.[] | select(.createdAt < (now - 86400 | todate)) | .databaseId' \
                  | xargs -I {} gh run delete {}

              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    delete_deployments:
        runs-on: ubuntu-latest
        permissions:
            deployments: write # Needed for deleting deployments
        steps:
            - name: Delete old deployments
              run: |
                  gh api repos/${{ github.repository }}/deployments \
                  --jq '.[] | select(.status != "active") | .id' \
                  | xargs -I {} gh api -X DELETE repos/${{ github.repository }}/deployments/{}
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
